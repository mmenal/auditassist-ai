<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>n8n Smart Chat</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0f2f5; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        #chat-container { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }

        .container {max-width: 900px;margin: auto;height: 100vh;display: flex;flex-direction: column;}
        .header {background: #5b3cc4;color: white;padding: 15px;text-align: center;font-size: 18px;}

        .message { max-width: 85%; padding: 12px 18px; border-radius: 18px; font-size: 15px; line-height: 1.5; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .user { align-self: flex-end; background-color: #007bff; color: white; border-bottom-right-radius: 2px; }
        .n8n { align-self: flex-start; background-color: white; color: #1c1e21; border-bottom-left-radius: 2px; }

        /* Estilos para el contenido Markdown dentro de las burbujas */
        .message pre { background: #282c34; color: #abb2bf; padding: 10px; border-radius: 8px; overflow-x: auto; }
        .message code { font-family: 'Courier New', Courier, monospace; background: rgba(0,0,0,0.05); padding: 2px 4px; border-radius: 4px; }
        .user code { background: rgba(255,255,255,0.2); }
        .message ul, .message ol { padding-left: 20px; margin: 5px 0; }

        .input-area { background: white; padding: 20px; display: flex; gap: 10px; border-top: 1px solid #ddd; }
        input { flex: 1; padding: 12px 20px; border: 1px solid #ddd; border-radius: 25px; outline: none; font-size: 15px; }
        button { background: #007bff; color: white; border: none; padding: 10px 25px; border-radius: 25px; cursor: pointer; font-weight: bold; }
        .typing { font-style: italic; color: #65676b; font-size: 13px; display: none; margin: 0 0 10px 25px; }
    </style>
</head>
<body>

<div class="container">

  <div class="header">
    Asistente de Auditoría ISO 9001 / ISO 27001
  </div>

  <!-- CONTEXTO DE AUDITORÍA -->
  <div class="context">
    <div class="context-grid">
      <select id="norma">
        <option value="ISO 9001">ISO 9001</option>
        <option value="ISO 27001">ISO 27001</option>
      </select>

      <input id="proceso" placeholder="Proceso auditado (ej: Compras)">
      <input id="empresa" placeholder="Empresa auditada">
      <input id="fecha" type="date">

      <input id="docs" type="file" multiple>
    </div>
    <small>Podés cargar auditorías pasadas, informes o registros como contexto.</small>
  </div>

    <div id="chat-container">
        <div class="message n8n">¡Hola! Soy tu asistente. Puedo procesar listas, <b>negritas</b> y hasta código. ¿Qué deseas consultar?</div>
    </div>
    <div id="typing-indicator" class="typing">n8n está procesando tu solicitud...</div>

    <div class="input-area">
        <input type="text" id="userInput" placeholder="Escribe un mensaje..." autocomplete="off">
        <button id="sendBtn" onclick="enviarMensaje()">Enviar</button>
    </div>
</div>

    <script>
        // Configuración de Sesión
        if (!sessionStorage.getItem('chat_session_id')) {
            sessionStorage.setItem('chat_session_id', 'sess-' + Math.random().toString(36).substr(2, 9));
        }
        const sessionId = sessionStorage.getItem('chat_session_id');

        function agregarMensaje(texto, clase) {
            const div = document.createElement('div');
            div.classList.add('message', clase);
            
            // Usamos marked.parse para convertir Markdown a HTML
            // Si es mensaje del usuario, enviamos texto plano por seguridad, 
            // si es de n8n, renderizamos el Markdown.
            div.innerHTML = clase === 'n8n' ? marked.parse(texto) : texto;
            
            //console.log(texto);
            
            document.getElementById('chat-container').appendChild(div);
            document.getElementById('chat-container').scrollTop = document.getElementById('chat-container').scrollHeight;
        }

        async function enviarMensaje() {
            const input = document.getElementById('userInput');
            const msg = input.value.trim();
            if (!msg) return;

            agregarMensaje(msg, 'user');
            input.value = '';
            
            document.getElementById('typing-indicator').style.display = 'block';
            document.getElementById('sendBtn').disabled = true;

            const formData = new FormData();
            formData.append("session_id", sessionId);
            formData.append("mensaje", msg);
            formData.append("norma", document.getElementById("norma").value);
            formData.append("proceso", document.getElementById("proceso").value);
            formData.append("empresa", document.getElementById("empresa").value);
            formData.append("fecha", document.getElementById("fecha").value);

            const files = document.getElementById("docs").files;
            for (let i = 0; i < files.length; i++) {
                formData.append("documentos", files[i]);
            }

            const webhook = "https://n8n.srv936362.hstgr.cloud/webhook-test/2b0d6559-bc3a-42fa-9885-7838021536b3";

            try {
                const response = await fetch(webhook, {
                    method: 'POST',
                    body: formData
                });

                //const response = await fetch(webhook, {
                //    method: 'POST',
                //    headers: { 'Content-Type': 'application/json' },
                //    body: JSON.stringify({ chatInput: msg, sessionId: sessionId })
                //});

                //if (!response.ok) {
                //    throw new Error('El servidor devolvió un error en la respuesta: ' + response.status);
                //}

                // parsea la respuesta JSON
                const data = await response.json();

                //const respuestaIA = JSON.parse(data);

                // n8n debe devolver un campo llamado "output"
                //agregarMensaje(data.output || "Error: No recibí respuesta válida.", 'n8n');
                
                console.log("Estructura real:", data);
                //console.log(JSON.stringify(data, null, 2));

                agregarMensaje(data.Resultado.evidencia || "Error: No recibí respuesta válida.", 'n8n');

            } catch (e) {
                agregarMensaje("Error de conexión con el servidor.", 'n8n');
                console.error(e);
                
            } finally {
                document.getElementById('typing-indicator').style.display = 'none';
                document.getElementById('sendBtn').disabled = false;
            }
        }

        document.getElementById('userInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') enviarMensaje();
        });
    </script>
</body>
</html>